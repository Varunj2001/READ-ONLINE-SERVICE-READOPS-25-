{% extends 'libapp/base.html' %}

{% block title %}My Dashboard - ReadOps{% endblock %}

{% block content %}
{% load static %}

<style>
    .dashboard-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .dashboard-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("{% static 'Images/Background.jpg' %}") center/cover;
        opacity: 0.1;
        z-index: 0;
    }

    .dashboard-hero-content {
        position: relative;
        z-index: 1;
        max-width: 800px;
        margin: 0 auto;
    }

    .dashboard-hero h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .dashboard-hero p {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 2rem;
    }

    .welcome-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .welcome-stat {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .welcome-stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .welcome-stat-label {
        font-size: 1rem;
        opacity: 0.9;
    }
</style>

<div class="dashboard-hero">
    <div class="dashboard-hero-content">
        <h1><i class="fas fa-user-circle"></i> Welcome back, {{ user.username }}!</h1>
        <p>Manage your borrowed books, track your reading progress, and discover new favorites</p>
        
        <div class="welcome-stats">
            <div class="welcome-stat">
                <div class="welcome-stat-number">{{ user_books|length }}</div>
                <div class="welcome-stat-label">Books Borrowed</div>
            </div>
            <div class="welcome-stat">
                <div class="welcome-stat-number">{{ user.cart|length }}</div>
                <div class="welcome-stat-label">Items in Cart</div>
            </div>
            <div class="welcome-stat">
                <div class="welcome-stat-number">{{ pending_fines|length }}</div>
                <div class="welcome-stat-label">Pending Fines</div>
            </div>
            <div class="welcome-stat">
                <div class="welcome-stat-number">üì±</div>
                <div class="welcome-stat-label">SMS Notifications</div>
            </div>
        </div>
        
        <!-- SMS Notification Status -->
        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 15px; padding: 1.5rem; margin: 2rem 0; border-left: 5px solid #2196f3;">
        <h4 style="color: #1976d2; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-envelope"></i> Email Notifications
        </h4>
        <p style="color: #424242; margin-bottom: 1rem;">
            <strong>Email Address:</strong> {{ user.email }}
        </p>
        <p style="color: #424242; margin-bottom: 1rem;">
            <i class="fas fa-check-circle" style="color: #4caf50;"></i> 
            You will receive email notifications for:
        </p>
        <ul style="color: #424242; margin-left: 1.5rem;">
            <li>üìö Book borrowing and returning</li>
            <li>üí≥ Payment confirmations</li>
            <li>‚ö†Ô∏è Fine reminders</li>
            <li>üìÖ Overdue book alerts</li>
            <li>üéâ Welcome messages</li>
        </ul>
        <div style="margin-top: 1rem;">
            <a href="{% url 'test_email' %}" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.75rem 1.5rem; border-radius: 25px; text-decoration: none; font-weight: 600; display: inline-block; transition: all 0.3s ease;">
                <i class="fas fa-paper-plane"></i> Test Email Notifications
            </a>
        </div>
        </div>
    </div>
</div>

<div class="user-dashboard">
        <!-- Access restriction notice -->
        {% if has_access_restrictions %}
        <div class="alert alert-info" style="margin-bottom: 20px; background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; padding: 15px; border-radius: 8px;">
            <i class="fas fa-info-circle"></i> <strong>Access Notice:</strong> You have pending fines, but you can still return books and report lost items. Please clear your fines to avoid further restrictions.
        </div>
        {% endif %}
        
        <div class="sidebarD">
        <div class="userDcon">
            <div class="sidebarHeadD">Name:</div>
            <p class="userDetails">{{ user.username }}</p>
        </div>

        <div class="userDcon">
            <div class="sidebarHeadD">Email:</div>
            <p class="userDetails">{{ user.email }}</p>
        </div>

        <div class="userDcon">
            <div class="sidebarHeadD">Phone:</div>
            <p class="userDetails">{{ user.phone }}</p>
        </div>
        <!-- Add more user details as needed -->
    </div>

    <div class="main-contentD">
        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="{% url 'generate_user_qr' %}" class="action-button" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <i class="fas fa-qrcode"></i> My QR Code
            </a>
            <a href="{% url 'view_payments' %}" class="action-button">
                <i class="fas fa-money-bill"></i> View My Payments
            </a>
            <a href="#fines" class="action-button {% if pending_fines %}attention{% endif %}">
                <i class="fas fa-exclamation-circle"></i> View Pending Fines
                {% if pending_fines %}
                <span class="badge">{{ pending_fines|length }}</span>
                {% endif %}
            </a>
        </div>

        <!-- Pending Fines Section -->
        {% if pending_fines %}
        <div id="fines" class="fines-section">
            <h2><i class="fas fa-exclamation-triangle"></i> Pending Fines</h2>
            <div class="fines-container">
                {% for fine in pending_fines %}
                <div class="fine-item {% if fine.is_overdue %}overdue{% endif %}">
                    <div class="fine-header">
                        <h3>{{ fine.book_title }}</h3>
                        <span class="fine-status">Pending Payment</span>
                    </div>
                    <div class="fine-details">
                        <p><i class="far fa-calendar-alt"></i> Due Date: {{ fine.due_date|date:"Y-m-d" }}</p>
                        <p><i class="fas fa-clock"></i> Days Overdue: {{ fine.days_overdue }}</p>
                        <p class="fine-amount"><i class="fas fa-dollar-sign"></i> Fine Amount: ${{ fine.amount }}</p>
                    </div>
                    <div class="fine-actions">
                        <a href="{% url 'payment' fine_id=fine.id %}" class="pay-button">
                            <i class="fas fa-credit-card"></i> Pay Now
                        </a>
                        <a href="{% url 'payment' fine_id=fine.id %}" class="view-button">
                            <i class="fas fa-eye"></i> View Details
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <h2><i class="fas fa-book"></i> My Borrowed Books</h2>
        
        <!-- Quick Return Section -->
        {% if user_books %}
        <div style="background: linear-gradient(135deg, #e8f5e8, #c8e6c9); border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; border-left: 5px solid #4caf50;">
            <h3 style="color: #2e7d32; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-undo"></i> Quick Return
            </h3>
            <p style="color: #424242; margin-bottom: 1rem;">
                You have <strong>{{ user_books|length }}</strong> borrowed book{{ user_books|length|pluralize }}. 
                Click the "Return Book" button below each book to return it.
            </p>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                {% for book in user_books %}
                <div style="background: white; border-radius: 10px; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-width: 200px;">
                    <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">{{ book.title }}</h4>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Due: {{ book.end_date|date:"M d, Y" }}</p>
                    <form action="{% url 'return_book' %}" method="post" style="display: inline;" onsubmit="return confirmReturnBook('{{ book.title }}')">
                        {% csrf_token %}
                        <input type="hidden" name="book_id" value="{{ book.id }}">
                        <button type="submit" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-undo"></i> Return This Book
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="dashboardBooksCon" style="display: flex; flex-wrap: wrap; gap: 40px; justify-content: flex-start;">
            {% if user_books %}
                {% for book in user_books %}
                    <div class="book-tileD" style="width: 480px; min-height: 520px;">
                        <div class="book-header">
                            {% if book.image %}
                                <img src="{{ book.image }}" alt="{{ book.title }}" class="book-image" style="width: 320px; height: 320px;">
                            {% endif %}
                            <div class="book-status {% if book.is_overdue %}overdue{% endif %}">
                                {% if book.is_overdue %}
                                    <i class="fas fa-exclamation-triangle"></i> Overdue - Return Now!
                                {% else %}
                                    <i class="fas fa-check-circle"></i> On Time
                                {% endif %}
                            </div>
                        </div>

                        <div class="book-info">
                            <h3>{{ book.title }}</h3>
                            <div class="date-info">
                                <div class="date-item">
                                    <i class="fas fa-calendar-plus"></i>
                                    <span>Borrowed: {{ book.start_date|date:"Y-m-d H:i:s" }}</span>
                                </div>
                                <div class="date-item due-date {% if book.is_overdue %}overdue-date{% endif %}">
                                    <i class="fas fa-calendar-times"></i>
                                    <span>Due: {{ book.end_date|date:"Y-m-d H:i:s" }}</span>
                                </div>
                            </div>
                            <div class="countdown-container {% if book.is_overdue %}overdue-countdown{% endif %}">
                                <p><i class="fas fa-hourglass-half"></i> 
                                {% if book.is_overdue %}
                                    <span class="overdue-label">OVERDUE BY:</span>
                                {% else %}
                                    <span>Time Remaining:</span>
                                {% endif %}
                                </p>
                                <div class="countdown" data-end-date="{{ book.end_date|date:'Y-m-d H:i:s' }}">
                                    <span class="days">0</span> <span class="time-label">days</span>
                                    <span class="hours">0</span> <span class="time-label">hrs</span>
                                    <span class="minutes">0</span> <span class="time-label">min</span>
                                    <span class="seconds">0</span> <span class="time-label">sec</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 10px; color: #444; font-size: 1em;">
                                <strong>Book ID:</strong> {{ book.id }}<br>
                                <strong>Status:</strong> {% if book.is_overdue %}Overdue{% else %}On Time{% endif %}<br>
                                <strong>Author:</strong> {{ book.author }}<br>
                                <strong>Category:</strong> {{ book.category }}<br>
                            </div>
                            <div class="book-actions">
                                {% if book.id %}
                                <a href="{% url 'generate_barcode' book_id=book.id %}" class="action-btn barcode-btn">
                                    <i class="fas fa-barcode"></i> View Barcode
                                </a>
                                <a href="{% url 'report_lost' book_id=book.id %}" class="action-btn lost-btn" {% if has_access_restrictions %}title="Report functionality available despite fines"{% endif %}>
                                    <i class="fas fa-exclamation-triangle"></i> Report Lost
                                </a>
                                <button onclick="showExtensionModal({{ book.id }})" class="action-btn extend-btn">
                                    <i class="fas fa-clock"></i> Extend
                                </button>
                                {% endif %}
                            </div>
                            <form action="{% url 'return_book' %}" method="post" class="return-book-form" onsubmit="return confirmReturnBook('{{ book.title }}')">
                                {% csrf_token %}
                                <input type="hidden" name="book_id" value="{{ book.id }}">
                                <button type="submit" class="return-book-btn" {% if has_access_restrictions %}title="Return functionality available despite fines"{% endif %}>
                                    <i class="fas fa-undo"></i> Return Book
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 3rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; border: 2px dashed #dee2e6;">
                    <i class="fas fa-book-open" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
                    <h3 style="color: #495057; margin-bottom: 1rem;">No Books Borrowed Yet</h3>
                    <p style="color: #6c757d; margin-bottom: 2rem;">You haven't borrowed any books yet. Start exploring our library!</p>
                    <a href="{% url 'explore' %}" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 1rem 2rem; border-radius: 25px; text-decoration: none; font-weight: 600; display: inline-block; transition: all 0.3s ease;">
                        <i class="fas fa-search"></i> Explore Books
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .quick-actions {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .action-button {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .action-button i {
        margin-right: 8px;
    }

    .action-button:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
    }

    .action-button.attention {
        background-color: #dc3545;
        animation: pulse 2s infinite;
    }

    .badge {
        background-color: white;
        color: #dc3545;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
        font-size: 0.8em;
        font-weight: bold;
    }

    .return-book-form {
        margin-top: 15px;
        text-align: center;
    }

    .return-book-btn {
        width: 100%;
        padding: 15px 25px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        position: relative;
        overflow: hidden;
    }

    .return-book-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .return-book-btn:hover::before {
        left: 100%;
    }

    .return-book-btn:hover {
        background: linear-gradient(135deg, #218838, #1ea085);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }

    .return-book-btn:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .return-book-btn i {
        font-size: 1.2em;
    }

    .book-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .action-btn {
        flex: 1;
        padding: 10px;
        text-align: center;
        text-decoration: none;
        color: white;
        border-radius: 6px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .barcode-btn {
        background-color: #6c757d;
    }

    .lost-btn {
        background-color: #dc3545;
    }

    .barcode-btn:hover, .lost-btn:hover {
        transform: translateY(-2px);
        filter: brightness(110%);
    }

    .fines-section {
        margin-bottom: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .fines-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    .fine-item {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        width: 350px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.3s ease;
    }

    .fine-item:hover {
        transform: translateY(-5px);
    }

    .fine-item.overdue {
        border-left: 4px solid #dc3545;
    }

    .fine-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .fine-header h3 {
        margin: 0;
        color: #2c3e50;
    }

    .fine-status {
        background-color: #ffc107;
        color: #000;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .fine-details {
        margin-bottom: 15px;
    }

    .fine-details p {
        margin: 8px 0;
        color: #666;
    }

    .fine-details i {
        width: 20px;
        color: #666;
    }
    
    .fine-amount {
        font-weight: bold;
        color: #dc3545;
    }

    .fine-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .pay-button, .view-button {
        flex: 1;
        padding: 8px 15px;
        border-radius: 6px;
        text-decoration: none;
        text-align: center;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .pay-button {
        background-color: #28a745;
        color: white;
    }

    .pay-button:hover {
        background-color: #218838;
        transform: translateY(-2px);
    }

    .view-button {
        background-color: #6c757d;
        color: white;
    }

    .view-button:hover {
        background-color: #5a6268;
        transform: translateY(-2px);
    }

    .book-tile {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease;
        margin-bottom: 20px;
    }

    .book-tile:hover {
        transform: translateY(-5px);
    }

    .book-header {
        position: relative;
        padding: 15px;
        background-color: #f8f9fa;
    }

    .book-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
    }

    .book-status {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
    }

    .book-status.overdue {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        animation: pulse-overdue 2s infinite;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        border: 2px solid #fff;
    }

    .book-status:not(.overdue) {
        background-color: #28a745;
        color: white;
    }

    .book-info {
        padding: 20px;
    }

    .book-info h3 {
        margin: 0 0 15px 0;
        color: #2c3e50;
    }

    .date-info {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
    }

    .date-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
    }

    .date-item i {
        color: #007bff;
    }

    .countdown-container {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .countdown-container p {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-weight: 500;
    }

    .countdown {
        display: flex;
        gap: 15px;
        justify-content: center;
        font-size: 1.1em;
        color: #007bff;
    }

    .countdown span {
        font-weight: bold;
    }

    .book-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 120px;
        opacity: 1 !important;
        visibility: visible !important;
    }

    .return-btn {
        background-color: #007bff;
        color: white;
    }

    .return-btn:hover {
        background-color: #0056b3;
    }

    .lost-btn {
        background-color: #dc3545;
        color: white;
    }

    .lost-btn:hover {
        background-color: #c82333;
    }

    .barcode-btn {
        background-color: #6c757d;
        color: white;
    }

    .barcode-btn:hover {
        background-color: #5a6268;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }

    .fine-actions {
        display: flex;
        gap: 10px;
    }
    
    .pay-button, .view-button {
        display: flex;
        align-items: center;
        padding: 8px 15px;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        transition: all 0.3s ease;
        flex: 1;
        justify-content: center;
    }

    .pay-button {
        background-color: #28a745;
    }

    .view-button {
        background-color: #17a2b8;
    }

    .pay-button:hover, .view-button:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    .pay-button i, .view-button i {
        margin-right: 6px;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }

    .fine-actions {
        display: flex;
        gap: 10px;
    }
    
    .pay-button, .view-button {
        display: flex;
        align-items: center;
        padding: 8px 15px;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        transition: all 0.3s ease;
        flex: 1;
        justify-content: center;
    }

    .pay-button {
        background-color: #28a745;
    }

    .view-button {
        background-color: #17a2b8;
    }

    .pay-button:hover, .view-button:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    .pay-button i, .view-button i {
        margin-right: 6px;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }
    
    .book-tileD {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 20px;
    }

    .book-tileD:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .book-header {
        position: relative;
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .book-image {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .book-status {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .book-status.overdue {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        animation: pulse-overdue 2s infinite;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        border: 2px solid #fff;
    }

    .book-status:not(.overdue) {
        background-color: #28a745;
        color: white;
    }

    .book-info {
        padding: 20px;
    }

    .book-info h3 {
        margin: 0 0 15px 0;
        color: #2c3e50;
        font-size: 1.4em;
    }

    .date-info {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .date-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
    }

    .date-item i {
        color: #007bff;
    }

    .countdown-container {
        margin: 15px 0;
        padding: 12px;
        background-color: #f8f9fa;
        border-radius: 8px;
        text-align: center;
    }

    .countdown-container p {
        margin: 0 0 8px 0;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .countdown {
        font-weight: bold;
        margin-top: 5px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    
    .countdown span {
        display: inline-block;
        background-color: #007bff;
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        min-width: 40px;
        text-align: center;
    }
    
    .countdown.warning span {
        background-color: #ffc107;
    }
    
    .countdown.danger span {
        background-color: #dc3545;
    }

    .book-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 6px;
        color: white;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        flex: 1;
    }

    .return-btn {
        background-color: #007bff;
    }

    .lost-btn {
        background-color: #dc3545;
    }

    .barcode-btn {
        background-color: #17a2b8;
    }

    .extend-btn {
        background-color: #ffc107;
        color: #212529;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        opacity: 0.9;
    }

    /* Extension Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f8f9fa;
    }

    .modal-title {
        color: #2c3e50;
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    .close {
        color: #aaa;
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .close:hover {
        color: #dc3545;
    }

    .extension-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .extension-option {
        padding: 1rem;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .extension-option:hover {
        border-color: #007bff;
        background: #e3f2fd;
        transform: translateY(-2px);
    }

    .extension-option.selected {
        border-color: #007bff;
        background: #007bff;
        color: white;
    }

    .extension-option h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1.2rem;
    }

    .extension-option p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    /* Enhanced due date styling */
    .due-date {
        font-weight: bold;
    }
    
    .overdue-date {
        color: #dc3545;
        animation: pulse-text 2s infinite;
    }
    
    .countdown-container {
        background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    
    .overdue-countdown {
        background: linear-gradient(145deg, #fff5f5, #f8d7da);
        border-left: 4px solid #dc3545;
    }
    
    .countdown {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        font-size: 1.2em;
        padding: 10px;
        border-radius: 8px;
    }
    
    .countdown span:not(.time-label) {
        display: inline-block;
        background-color: #007bff;
        color: white;
        border-radius: 6px;
        padding: 5px 8px;
        min-width: 40px;
        text-align: center;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .overdue-countdown .countdown span:not(.time-label) {
        background-color: #dc3545;
    }
    
    .time-label {
        color: #6c757d;
        font-size: 0.9em;
    }
    
    .overdue-label {
        color: #dc3545;
        font-weight: bold;
        animation: pulse-text 2s infinite;
    }
    
    .warning .countdown span:not(.time-label) {
        background-color: #ffc107;
        color: #212529;
    }
    
    .danger .countdown span:not(.time-label) {
        background-color: #dc3545;
    }
    
    @keyframes pulse-text {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    @keyframes pulse-overdue {
        0%, 100% { 
            transform: scale(1);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }
        50% { 
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all countdown timers
        const countdowns = document.querySelectorAll('.countdown');
        
        countdowns.forEach(function(countdown) {
            const endDateStr = countdown.getAttribute('data-end-date');
            const endDate = new Date(endDateStr);
            
            // Update countdown every second
            updateCountdown(countdown, endDate);
            setInterval(function() {
                updateCountdown(countdown, endDate);
            }, 1000);
            
            // Set reminder notification
            setReminder(endDateStr);
        });
        
        function updateCountdown(element, endDate) {
            const now = new Date();
            const timeDiff = endDate - now;
            
            // Handle overdue books
            if (timeDiff <= 0) {
                // For overdue books, show days overdue instead
                const daysOverdue = Math.abs(Math.floor(timeDiff / (1000 * 60 * 60 * 24)));
                const hoursOverdue = Math.floor((Math.abs(timeDiff) % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutesOverdue = Math.floor((Math.abs(timeDiff) % (1000 * 60 * 60)) / (1000 * 60));
                const secondsOverdue = Math.floor((Math.abs(timeDiff) % (1000 * 60)) / 1000);
                
                // Update the countdown display with overdue time
                element.querySelector('.days').textContent = daysOverdue;
                element.querySelector('.hours').textContent = hoursOverdue;
                element.querySelector('.minutes').textContent = minutesOverdue;
                element.querySelector('.seconds').textContent = secondsOverdue;
                
                element.closest('.countdown-container').classList.add('overdue-countdown');
                return;
            }
            
            // Calculate days, hours, minutes, seconds for books not yet due
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            
            // Update the countdown display
            element.querySelector('.days').textContent = days;
            element.querySelector('.hours').textContent = hours;
            element.querySelector('.minutes').textContent = minutes;
            element.querySelector('.seconds').textContent = seconds;
            
            // Add warning class if less than 2 days remaining
            if (days < 2) {
                element.closest('.countdown-container').classList.add('warning');
            }
            
            // Add danger class if less than 1 day remaining
            if (days < 1) {
                element.closest('.countdown-container').classList.add('danger');
            }
        }
        
        function setReminder(endDateStr) {
            // Check if browser supports notifications
            if (!("Notification" in window)) {
                console.log("This browser does not support notifications");
                return;
            }
            
            // Check if we already have permission
            if (Notification.permission === "granted") {
                scheduleReminder(endDateStr);
            } else if (Notification.permission !== "denied") {
                // Request permission
                Notification.requestPermission().then(function(permission) {
                    if (permission === "granted") {
                        scheduleReminder(endDateStr);
                    }
                });
            }
        }
        
        function scheduleReminder(endDateStr) {
            const endDate = new Date(endDateStr);
            const now = new Date();
            
            // Set reminders at different intervals
            const reminderDates = [
                { days: 1, message: "Your book is due tomorrow. Please return it to avoid fines." },
                { days: 3, message: "Your book is due in 3 days. Please plan to return it soon." },
                { days: 7, message: "Your book is due in a week. Just a friendly reminder." }
            ];
            
            reminderDates.forEach(reminder => {
                const reminderDate = new Date(endDate);
                reminderDate.setDate(reminderDate.getDate() - reminder.days);
                
                // If reminder date is in the future, schedule it
                if (reminderDate > now) {
                    const timeUntilReminder = reminderDate - now;
                    
                    setTimeout(function() {
                        new Notification("Book Due Reminder", {
                            body: reminder.message,
                            icon: "/static/libapp/images/logo.png"
                    });
                }, timeUntilReminder);
                }
            });
        }
        
        // Add click event for return buttons to confirm before submission
        document.querySelectorAll('.return-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                if (!confirm('Are you sure you want to return this book?')) {
                    e.preventDefault();
                }
            });
        });
    });

    // Extension functionality
    let currentBookId = null;
    let selectedDays = null;

    function showExtensionModal(bookId) {
        currentBookId = bookId;
        document.getElementById('extensionModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeExtensionModal() {
        document.getElementById('extensionModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        currentBookId = null;
        selectedDays = null;
        // Reset selections
        document.querySelectorAll('.extension-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.getElementById('extendSubmitBtn').disabled = true;
    }

    function selectExtension(days) {
        selectedDays = days;
        // Remove previous selection
        document.querySelectorAll('.extension-option').forEach(option => {
            option.classList.remove('selected');
        });
        // Add selection to clicked option
        event.target.closest('.extension-option').classList.add('selected');
        // Enable submit button
        document.getElementById('extendSubmitBtn').disabled = false;
    }

    function submitExtension() {
        if (currentBookId && selectedDays) {
            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/extend_book/${currentBookId}/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            const daysInput = document.createElement('input');
            daysInput.type = 'hidden';
            daysInput.name = 'days';
            daysInput.value = selectedDays;
            form.appendChild(daysInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('extensionModal');
        if (event.target === modal) {
            closeExtensionModal();
        }
    }

    // Return book confirmation function
    function confirmReturnBook(bookTitle) {
        return confirm(`Are you sure you want to return "${bookTitle}"?\n\nThis action will remove the book from your borrowed list and make it available for other users.`);
    }
</script>

<!-- Extension Modal -->
<div id="extensionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-clock"></i> Extend Book Return Date
            </h2>
            <span class="close" onclick="closeExtensionModal()">&times;</span>
        </div>
        
        <p style="color: #666; margin-bottom: 1.5rem;">
            Select how many days you'd like to extend your book return date:
        </p>
        
        <div class="extension-options">
            <div class="extension-option" data-days="3" onclick="selectExtension(3)">
                <h4>3 Days</h4>
                <p>Short extension</p>
            </div>
            <div class="extension-option" data-days="7" onclick="selectExtension(7)">
                <h4>7 Days</h4>
                <p>Standard extension</p>
            </div>
            <div class="extension-option" data-days="14" onclick="selectExtension(14)">
                <h4>14 Days</h4>
                <p>Extended period</p>
            </div>
            <div class="extension-option" data-days="30" onclick="selectExtension(30)">
                <h4>30 Days</h4>
                <p>Long extension</p>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeExtensionModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitExtension()" id="extendSubmitBtn" disabled>
                <i class="fas fa-clock"></i> Extend Book
            </button>
        </div>
    </div>
</div>
{% endblock %}
