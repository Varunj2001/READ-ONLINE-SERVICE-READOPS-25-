from django.shortcuts import redirect, render, get_object_or_404
from django.http import JsonResponse, HttpResponse, HttpResponseNotAllowed
from decimal import Decimal
from .models import Book
from .forms import BookRequestForm
from .forms import BookFilterForm
from .forms import RegistrationForm, LoginForm
from .forms import UserUpdateForm
from django.contrib import messages
from django.contrib.auth import authenticate,login as auth_login,logout as auth_logout
from django.contrib.auth.decorators import login_required
from django.db.models import Q
from django.utils import timezone
from .models import CustomUser, Fine, Payment, MobileNotification
from .email_service import email_service
from django.contrib.auth.decorators import user_passes_test
from django.urls import reverse
from .decorators import check_fine_access, require_no_excessive_fines


# Create your views here.

def logout_view(request):
    auth_logout(request)
    messages.success(request, 'You have been successfully logged out.')
    return redirect('home')

def index(request):
    return render(request, 'libapp/index.html')

def home(request):
    context = {}
    if request.user.is_authenticated:
        # Add today's date for comparison in template
        context['today'] = timezone.now().date()
        
        # Process user's books to check for overdue status
        if hasattr(request.user, 'books') and request.user.books:
            for book in request.user.books:
                end_date_str = book.get('end_date')
                if end_date_str:
                    end_date = timezone.datetime.fromisoformat(end_date_str).date()
                    current_date = timezone.now().date()
                    book['is_overdue'] = end_date < current_date
    
    return render(request, 'libapp/home.html', context)
    
@login_required
@user_passes_test(lambda u: u.is_librarian)
def status_view(request):
    # Get all books in the system
    all_books = Book.objects.all()
    
    # Get statistics
    total_books = all_books.count()
    available_books = all_books.filter(quantity__gt=0).count()
    borrowed_books = 0
    returned_books = 0
    
    # Count lost books (books with quantity = 0 and have associated fines)
    lost_books = 0
    # Fine.status choices use 'PENDING' uppercase; use matching value
    lost_books_fines = Fine.objects.filter(status='PENDING').values('book_title').distinct()
    lost_books = len(lost_books_fines)
    
    # Count borrowed books
    users_with_books = CustomUser.objects.filter(books__isnull=False)
    
    # Process user book data to include return status
    for user in users_with_books:
        for book in user.books:
            # Calculate if the book is overdue
            end_date_str = book.get('end_date')
            if end_date_str:
                end_date = timezone.datetime.fromisoformat(end_date_str)
                current_date = timezone.now()
                
                # Check if book is returned
                if book.get('is_returned', False):
                    returned_books += 1
                    book['is_returned'] = True
                    book['is_overdue'] = False
                else:
                    borrowed_books += 1
                    book['is_returned'] = False
                    book['is_overdue'] = end_date < current_date
    
    context = {
        'total_books': total_books,
        'available_books': available_books,
        'borrowed_books': borrowed_books,
        'returned_books': returned_books,
        'lost_books': lost_books,
        'users_with_books': users_with_books,
    }
    
    return render(request, 'libapp/status.html', context)

def explore(request):
    search_query = request.GET.get('q')
    books = Book.objects.all()

    if search_query:
        # Filter the books based on the search query using Q object and icontains lookup
        books = books.filter(
            Q(title__icontains=search_query) | 
            Q(author__icontains=search_query) | 
            Q(department__icontains=search_query) | 
            Q(subject__icontains=search_query)
        )

    context = {
        'books': books,
    }
    return render(request, 'libapp/explore.html', context)

def explore_view(request):
    form = BookFilterForm(request.GET)
    books = Book.objects.all()

    if form.is_valid():
        department = form.cleaned_data['department']
        subjects = form.cleaned_data['subjects']

        if department:
            books = books.filter(department=department)

        if subjects:
            books = books.filter(subject__in=subjects)

    return render(request, 'libapp/explore.html', {'books': books, 'form': form})

@login_required(login_url='login')
@require_no_excessive_fines
def book_request_view(request):
    if request.method == 'POST':
        book_id = request.POST.get('book')
        try:
            book = Book.objects.get(pk=book_id)
        except Book.DoesNotExist:
            messages.error(request, 'Book not found.')
            return redirect('explore')

        if book.quantity > 0:
            # Reduce the book quantity by 1
            book.quantity -= 1
            book.save()

            # Add book details to the user's "books" list
            if request.user.is_authenticated:
                request.user.take_book(book)
                messages.success(request, f'Successfully taken {book.title}.')
                
                # Create mobile notification
                notification = MobileNotification.objects.create(
                    user=request.user,
                    notification_type='BOOK_BORROWED',
                    title=f'Book Borrowed: {book.title}',
                    message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
                    book_title=book.title,
                    book_id=book.id
                )
                messages.info(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
                
            # Send email notification for book borrowing
            try:
                email_service.send_book_borrowed_email(request.user, book, notification.bima_id)
                messages.info(request, 'Email notification sent to your registered email address!')
            except Exception as e:
                print(f"Email sending failed: {str(e)}")
                # Don't fail book borrowing if email fails
            else:
                messages.error(request, 'You need to be logged in to take a book.')
        else:
            messages.error(request, 'The book is not available.')

    return redirect('user_dashboard')

@login_required(login_url='login')
@check_fine_access
def return_book_view(request):
    """Handle returning a book: remove from user's JSON list and restore quantity."""
    if request.method != 'POST':
        return redirect('user_dashboard')

    book_id = request.POST.get('book_id')
    if not book_id:
        messages.error(request, 'Missing book identifier.')
        return redirect('user_dashboard')

    try:
        book_id_int = int(book_id)
    except (TypeError, ValueError):
        messages.error(request, 'Invalid book identifier.')
        return redirect('user_dashboard')

    # Remove the book entry from the user's JSON list
    user_books = getattr(request.user, 'books', []) or []
    original_len = len(user_books)
    updated_books = [b for b in user_books if b.get('id') != book_id_int]

    if len(updated_books) < original_len:
        request.user.books = updated_books
        request.user.save()

        # Restore the book quantity in the catalog if the book exists
        db_book = Book.objects.filter(id=book_id_int).first()
        if db_book:
            db_book.quantity = db_book.quantity + 1
            db_book.save()

        messages.success(request, 'Book returned successfully.')
        
        # Create mobile notification for return
        if db_book:
            notification = MobileNotification.objects.create(
                user=request.user,
                notification_type='BOOK_RETURNED',
                title=f'Book Returned: {db_book.title}',
                message=f'You have successfully returned "{db_book.title}" by {db_book.author}. Please confirm this transaction.',
                book_title=db_book.title,
                book_id=db_book.id
            )
            messages.info(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
            
            # Send email notification for book return
            try:
                email_service.send_book_returned_email(request.user, db_book, notification.bima_id)
                messages.info(request, 'Email notification sent to your registered email address!')
            except Exception as e:
                print(f"Email sending failed: {str(e)}")
                # Don't fail book return if email fails
    else:
        messages.warning(request, 'Book not found in your borrowed list.')

    return redirect('user_dashboard')


def get_subjects_view(request):
    selected_department = request.GET.get('dept')
    subjects = Book.objects.filter(department=selected_department).values_list('subject', flat=True).distinct()
    selected_subjects = request.GET.getlist('subjects[]')
    return JsonResponse({'subjects': list(subjects), 'selected_subjects': selected_subjects})

def get_books_view(request):
    selected_department = request.GET.get('dept')
    selected_subjects = request.GET.getlist('subjects[]')
    books = Book.objects.all()
    if selected_department:
        books = books.filter(department=selected_department)
    if selected_subjects:
        books = books.filter(subject__in=selected_subjects)
    book_data = [{'title': book.title, 'description': book.description, 'author': book.author,
                  'quantity': book.quantity, 'department': book.department, 'subject': book.subject,
                  'image': book.image.url if book.image else ''} for book in books]
    return JsonResponse({'books': book_data})

def aboutus_view(request):
    """About Us page with modern content and styling."""
    return render(request, 'libapp/aboutus.html')

@login_required
@user_passes_test(lambda u: u.is_librarian)
def update_book_details(request, book_pk):
    try:
        book = Book.objects.get(pk=book_pk)
        return render(request, 'libapp/update_book_details.html', {'book': book})
    except Book.DoesNotExist:
        messages.error(request, "Book not found.")
        return redirect('explore')

@login_required
@user_passes_test(lambda u: u.is_librarian)
def save_book_details(request, book_pk):
    if request.method != 'POST':
        return redirect('explore')
    
    try:
        book = Book.objects.get(pk=book_pk)
        
        # Update book details from form
        book.title = request.POST.get('title')
        book.author = request.POST.get('author')
        book.quantity = request.POST.get('quantity')
        book.department = request.POST.get('department')
        book.subject = request.POST.get('subject')
        book.description = request.POST.get('description')
        
        # Handle image upload
        if 'image' in request.FILES:
            book.image = request.FILES['image']
        
        book.save()
        messages.success(request, "Book details updated successfully.")
        return redirect('explore')
    except Book.DoesNotExist:
        messages.error(request, "Book not found.")
        return redirect('explore')

@login_required
@user_passes_test(lambda u: u.is_librarian)
def render_add_new_book_page(request):
    return render(request, 'libapp/add_new_book.html')

@login_required
@user_passes_test(lambda u: u.is_librarian)
def save_new_book(request):
    if request.method != 'POST':
        return redirect('add_new_book')
    
    # Extract book details from form
    title = request.POST.get('title')
    author = request.POST.get('author')
    quantity = request.POST.get('quantity')
    department = request.POST.get('department')
    subject = request.POST.get('subject')
    description = request.POST.get('description')
    
    # Validate required fields
    if not all([title, author, quantity, department, subject]):
        messages.error(request, "All fields are required.")
        return redirect('add_new_book')
    
    try:
        # Create new book
        book = Book(
            title=title,
            author=author,
            quantity=int(quantity),
            department=department,
            subject=subject,
            description=description
        )
        
        # Handle image upload
        if 'image' in request.FILES:
            book.image = request.FILES['image']
        
        book.save()
        messages.success(request, "Book added successfully.")
        return redirect('explore')
    except Exception as e:
        messages.error(request, f"Error adding book: {str(e)}")
        return redirect('add_new_book')

@login_required
@user_passes_test(lambda u: u.is_librarian)
def librarian_dashboard(request):
    users_with_books = CustomUser.objects.filter(books__isnull=False)
    context = {
        'librarian': request.user,
        'users_with_books': users_with_books,
    }
    return render(request, 'libapp/librarian_dashboard.html', context)

@login_required
@user_passes_test(lambda u: u.is_librarian)
def remind_user(request):
    messages.info(request, 'Reminder sent (placeholder).')
    return redirect('librarian_dashboard')

@login_required
def payment_view(request, fine_id):
    fine = get_object_or_404(Fine, id=fine_id)
    return render(request, 'libapp/payment.html', {'fine': fine, 'amount': fine.amount})

@login_required
def pay_fine(request):
    if request.method != 'POST':
        return redirect('user_dashboard')

    fine_id = request.POST.get('fine_id')
    confirm = request.POST.get('confirm_payment')
    payment_method = request.POST.get('payment_method', 'card')
    bank_name = request.POST.get('bank_name', '')
    
    if not (fine_id and confirm):
        messages.error(request, 'Payment confirmation required.')
        return redirect('user_dashboard')

    fine = get_object_or_404(Fine, id=fine_id)
    related_book = Book.objects.filter(id=fine.book_id).first() if fine.book_id else None
    
    # Create payment record with payment method details
    payment = Payment.objects.create(
        user=request.user,
        book=related_book,
        book_title=fine.book_title,
        amount=fine.amount,
        payment_type='FINE',
        payment_method=payment_method,
        bank_name=bank_name if payment_method == 'netbanking' else None,
    )

    fine.status = 'PAID'
    fine.save()

    # Show success message based on payment method
    if payment_method == 'netbanking':
        messages.success(request, f'Payment initiated via Net Banking ({bank_name}). You will be redirected to your bank\'s secure website.')
    elif payment_method == 'upi':
        messages.success(request, 'Payment initiated via UPI. Please complete the payment in your UPI app.')
    elif payment_method == 'wallet':
        messages.success(request, 'Payment initiated via Digital Wallet. Please complete the payment in your wallet app.')
    else:
        messages.success(request, 'Payment processed successfully via Credit/Debit Card.')

    # Send email notification for successful payment
    try:
        email_service.send_payment_success_email(request.user, fine.amount, payment_method, fine.book_title)
        messages.info(request, 'Payment confirmation email sent to your registered email address!')
    except Exception as e:
        print(f"Email sending failed: {str(e)}")
        # Don't fail payment if email fails

    return redirect('payment_receipt', payment_id=payment.id)

@login_required
def pay_lost_book(request):
    if request.method != 'POST':
        return redirect('user_dashboard')

    book_id = request.POST.get('book_id')
    amount = request.POST.get('amount')
    confirm = request.POST.get('confirm_payment')
    payment_method = request.POST.get('payment_method', 'card')
    bank_name = request.POST.get('bank_name', '')
    
    if not (book_id and amount and confirm):
        messages.error(request, 'Payment confirmation required.')
        return redirect('user_dashboard')

    try:
        amount_dec = Decimal(str(amount))
    except Exception:
        messages.error(request, 'Invalid amount.')
        return redirect('user_dashboard')

    book = Book.objects.filter(id=book_id).first()
    payment = Payment.objects.create(
        user=request.user,
        book=book,
        book_title=book.title if book else 'Unknown Book',
        amount=amount_dec,
        payment_type='LOST',
        payment_method=payment_method,
        bank_name=bank_name if payment_method == 'netbanking' else None,
    )

    # Show success message based on payment method
    if payment_method == 'netbanking':
        messages.success(request, f'Payment initiated via Net Banking ({bank_name}). You will be redirected to your bank\'s secure website.')
    elif payment_method == 'upi':
        messages.success(request, 'Payment initiated via UPI. Please complete the payment in your UPI app.')
    elif payment_method == 'wallet':
        messages.success(request, 'Payment initiated via Digital Wallet. Please complete the payment in your wallet app.')
    else:
        messages.success(request, 'Payment processed successfully via Credit/Debit Card.')

    # Send email notification for successful payment
    try:
        book_title = book.title if book else 'Unknown Book'
        email_service.send_payment_success_email(request.user, amount_dec, payment_method, book_title)
        messages.info(request, 'Payment confirmation email sent to your registered email address!')
    except Exception as e:
        print(f"Email sending failed: {str(e)}")
        # Don't fail payment if email fails

    return redirect('payment_receipt', payment_id=payment.id)

@login_required
def add_fine(request):
    if request.method == 'POST' and request.user.is_librarian:
        user_id = request.POST.get('user_id')
        book_title = request.POST.get('book_title')
        book_id = request.POST.get('book_id')
        amount = request.POST.get('amount')
        due_date = timezone.now() + timezone.timedelta(days=7)
        try:
            amount_dec = Decimal(str(amount))
        except Exception:
            amount_dec = Decimal('5.00')
        user = get_object_or_404(CustomUser, id=user_id)
        Fine.objects.create(
            user=user,
            book_title=book_title or 'Unknown Book',
            book_id=int(book_id) if book_id else None,
            due_date=due_date,
            amount=amount_dec,
            days_overdue=0,
            status='PENDING',
        )
        messages.success(request, 'Fine added.')
        return redirect('librarian_dashboard')
    return redirect('home')

@login_required
def payment_receipt(request, payment_id):
    payment = get_object_or_404(Payment, id=payment_id)
    return render(request, 'libapp/view_payment.html', {'payment': payment})

@login_required
def view_payments(request):
    if request.user.is_librarian:
        payments = Payment.objects.all().order_by('-payment_date')
    else:
        payments = Payment.objects.filter(user=request.user).order_by('-payment_date')
    return render(request, 'libapp/view_payments.html', {'payments': payments})

@login_required
def view_payment(request, payment_id):
    payment = get_object_or_404(Payment, id=payment_id)
    if not request.user.is_librarian and payment.user_id != request.user.id:
        messages.error(request, 'Access denied to this payment.')
        return redirect('view_payments')
    return render(request, 'libapp/view_payment.html', {'payment': payment})

@login_required
def generate_barcode(request, book_id):
    return HttpResponse(f"BARCODE-{book_id}")

# Cart functionality
@login_required
def add_to_cart(request, book_id):
    """Add book to user's cart"""
    try:
        book = Book.objects.get(pk=book_id)
        if book.quantity > 0:
            success = request.user.add_to_cart(book)
            if success:
                messages.success(request, f'{book.title} added to cart!')
            else:
                messages.warning(request, f'{book.title} is already in your cart!')
        else:
            messages.error(request, 'Book is not available!')
    except Book.DoesNotExist:
        messages.error(request, 'Book not found!')
    return redirect('explore')

@login_required
def remove_from_cart(request, book_id):
    """Remove book from user's cart"""
    success = request.user.remove_from_cart(book_id)
    if success:
        messages.success(request, 'Book removed from cart!')
    else:
        messages.error(request, 'Book not found in cart!')
    return redirect('cart_view')

@login_required
def cart_view(request):
    """Display user's cart"""
    cart_items = request.user.cart
    context = {
        'cart_items': cart_items,
        'cart_count': len(cart_items)
    }
    return render(request, 'libapp/cart.html', context)

@login_required
def checkout_cart(request):
    """Checkout all items in cart"""
    if request.method == 'POST':
        cart_items = request.user.cart
        if not cart_items:
            messages.warning(request, 'Your cart is empty!')
            return redirect('cart_view')
        
        # Process each book in cart
        borrowed_books = []
        unavailable_books = []
        
        for item in cart_items:
            try:
                book = Book.objects.get(pk=item['book_id'])
                if book.quantity > 0:
                    book.quantity -= 1
                    book.save()
                    request.user.take_book(book)
                    borrowed_books.append(book.title)
                else:
                    unavailable_books.append(book.title)
            except Book.DoesNotExist:
                unavailable_books.append(item['title'])
        
        # Clear cart
        request.user.clear_cart()
        
        if borrowed_books:
            messages.success(request, f'Successfully borrowed: {", ".join(borrowed_books)}')
        if unavailable_books:
            messages.warning(request, f'These books are no longer available: {", ".join(unavailable_books)}')
        
        return redirect('user_dashboard')
    
    return redirect('cart_view')

@login_required
def extend_book(request, book_id):
    """Extend book return date"""
    if request.method == 'POST':
        days = int(request.POST.get('days', 7))
        success = request.user.extend_book(book_id, days)
        if success:
            messages.success(request, f'Book return date extended by {days} days!')
        else:
            messages.error(request, 'Book not found in your borrowed books!')
    return redirect('user_dashboard')

# AI-powered features
@login_required
def ai_recommendations(request):
    """AI-powered book recommendations based on user's borrowing history"""
    user_books = request.user.books
    borrowed_subjects = []
    borrowed_departments = []
    
    # Analyze user's borrowing history
    for book in user_books:
        if book.get('id'):
            try:
                db_book = Book.objects.get(id=book['id'])
                borrowed_subjects.append(db_book.subject)
                borrowed_departments.append(db_book.department)
            except Book.DoesNotExist:
                continue
    
    # Get recommendations based on user's interests
    recommendations = []
    
    if borrowed_subjects:
        # Find books in similar subjects
        similar_books = Book.objects.filter(
            subject__in=borrowed_subjects
        ).exclude(
            id__in=[book.get('id') for book in user_books if book.get('id')]
        ).distinct()[:6]
        recommendations.extend(similar_books)
    
    if borrowed_departments:
        # Find books in similar departments
        dept_books = Book.objects.filter(
            department__in=borrowed_departments
        ).exclude(
            id__in=[book.get('id') for book in user_books if book.get('id')]
        ).distinct()[:4]
        recommendations.extend(dept_books)
    
    # If no history, recommend popular books
    if not recommendations:
        recommendations = Book.objects.filter(quantity__gt=0).order_by('-quantity')[:8]
    
    # Remove duplicates and limit to 8 recommendations
    seen_ids = set()
    unique_recommendations = []
    for book in recommendations:
        if book.id not in seen_ids:
            unique_recommendations.append(book)
            seen_ids.add(book.id)
        if len(unique_recommendations) >= 8:
            break
    
    context = {
        'recommendations': unique_recommendations,
        'user_history': {
            'subjects': list(set(borrowed_subjects)),
            'departments': list(set(borrowed_departments)),
            'total_books': len(user_books)
        }
    }
    return render(request, 'libapp/ai_recommendations.html', context)

@login_required
def ai_search(request):
    """AI-powered search with natural language processing"""
    query = request.GET.get('q', '').strip()
    if not query:
        return JsonResponse({'books': [], 'suggestions': []})
    
    # Simple AI-like search by expanding keywords
    search_terms = query.lower().split()
    expanded_terms = []
    
    # Expand common terms
    term_expansions = {
        'cs': ['computer', 'science', 'programming'],
        'math': ['mathematics', 'calculus', 'algebra'],
        'eng': ['engineering', 'mechanical', 'electrical'],
        'ai': ['artificial', 'intelligence', 'machine', 'learning'],
        'data': ['data', 'science', 'analytics', 'statistics'],
        'web': ['web', 'development', 'html', 'css', 'javascript'],
        'db': ['database', 'sql', 'mysql', 'postgresql']
    }
    
    for term in search_terms:
        if term in term_expansions:
            expanded_terms.extend(term_expansions[term])
        else:
            expanded_terms.append(term)
    
    # Search in multiple fields
    books = Book.objects.filter(
        Q(title__icontains=query) |
        Q(author__icontains=query) |
        Q(description__icontains=query) |
        Q(department__icontains=query) |
        Q(subject__icontains=query)
    )
    
    # Also search with expanded terms
    for term in expanded_terms:
        books = books | Book.objects.filter(
            Q(title__icontains=term) |
            Q(author__icontains=term) |
            Q(description__icontains=term) |
            Q(department__icontains=term) |
            Q(subject__icontains=term)
        )
    
    books = books.distinct()[:10]
    
    # Generate suggestions
    suggestions = []
    if books:
        # Get unique departments and subjects from results
        departments = books.values_list('department', flat=True).distinct()[:3]
        subjects = books.values_list('subject', flat=True).distinct()[:3]
        suggestions = list(departments) + list(subjects)
    
    book_data = []
    for book in books:
        book_data.append({
            'id': book.id,
            'title': book.title,
            'author': book.author,
            'department': book.department,
            'subject': book.subject,
            'image': book.image.url if book.image else None,
            'quantity': book.quantity,
            'description': book.description[:100] + '...' if len(book.description) > 100 else book.description
        })
    
    return JsonResponse({
        'books': book_data,
        'suggestions': suggestions[:5],
        'total_found': len(book_data)
    })

@login_required(login_url='login')
def report_lost_book(request, book_id):
    """Allow user to report a lost book; create a pending fine and remove from user list."""
    # Find the book record if present
    db_book = Book.objects.filter(id=book_id).first()

    # Remove the book from the user's JSON list
    user_books = getattr(request.user, 'books', []) or []
    updated_books = [b for b in user_books if b.get('id') != book_id]
    if len(updated_books) < len(user_books):
        request.user.books = updated_books
        request.user.save()

    # Determine book title for fine
    book_title = db_book.title if db_book else next((b.get('title') for b in user_books if b.get('id') == book_id), 'Unknown Book')

    # Create a pending fine for lost book (flat amount for now)
    due_date = timezone.now() + timezone.timedelta(days=7)
    Fine.objects.create(
        user=request.user,
        book_title=book_title,
        book_id=book_id,
        due_date=due_date,
        amount=Decimal('50.00'),
        days_overdue=0,
        status='PENDING',
    )

    messages.success(request, 'Lost book reported successfully. A pending fine was created.')
    return redirect('user_dashboard')


def login_view(request):
    return render(request,'libapp/login.html')
def signup(request):
    return render(request, 'libapp/register.html')

def register(request):
    # GET: show registration form
    if request.method == 'GET':
        form = RegistrationForm()
        return render(request, 'libapp/register.html', {'form': form})

    # POST: validate and create user
    form = RegistrationForm(request.POST)
    if form.is_valid():
        username = form.cleaned_data['username']
        password = form.cleaned_data['password']
        email = form.cleaned_data['email']
        phone = form.cleaned_data['phone']

        # Basic validations
        if len(username) < 5:
            messages.error(request, 'Username must be at least 5 characters long.')
            return render(request, 'libapp/register.html', {'form': form})

        if len(password) < 8:
            messages.error(request, 'Password must be at least 8 characters long.')
            return render(request, 'libapp/register.html', {'form': form})

        if len(phone) < 10:
            messages.error(request, 'Phone number should have at least ten digits.')
            return render(request, 'libapp/register.html', {'form': form})

        # Uniqueness checks
        if CustomUser.objects.filter(username=username).exists():
            messages.error(request, 'Username is already taken. Choose another.')
            return render(request, 'libapp/register.html', {'form': form})

        if CustomUser.objects.filter(email=email).exists():
            messages.error(request, 'An account with this email already exists.')
            return render(request, 'libapp/register.html', {'form': form})

        # Persist user in DB (with hashed password)
        user = form.save(commit=False)
        user.set_password(password)
        user.email = email
        user.phone = phone
        user.save()

        # Send email notification for successful registration
        try:
            email_service.send_registration_email(user)
            messages.info(request, 'Welcome email sent to your registered email address!')
        except Exception as e:
            print(f"Email sending failed: {str(e)}")
            # Don't fail registration if email fails

        # Do NOT auto-login; require explicit login
        messages.success(request, 'Account created successfully. Please log in to continue.')
        return redirect('login')

    # Invalid form: re-render form with errors
    messages.error(request, 'Please correct the errors and try again.')
    return render(request, 'libapp/register.html', {'form': form})

def login_user(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None:
            auth_login(request, user)
            messages.success(request, f'Welcome back, {user.username}!')
            return redirect('user_dashboard')
        else:
            messages.error(request, 'Invalid username or password.')
            return redirect('login')
    return redirect('login')

def login_librarian(request):
    """Render librarian login page on GET; authenticate librarian on POST."""
    if request.method == 'GET':
        return render(request, 'libapp/librarian_login.html')

    # POST: attempt authentication
    username = request.POST.get('username')
    password = request.POST.get('password')
    user = authenticate(username=username, password=password)

    if user is not None and getattr(user, 'is_librarian', False):
        auth_login(request, user)
        messages.success(request, f'Welcome back, Librarian {user.username}!')
        return redirect('librarian_dashboard')

    messages.error(request, 'Invalid librarian credentials.')
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })

@login_required
def user_dashboard(request):
    """
    User dashboard: show user info, books taken, and pending fines.
    Builds context from the JSON `request.user.books` and Fine records.
    """
    # Build a list of the user's books from the JSON field
    user_books = []
    if hasattr(request.user, 'books') and request.user.books:
        for book in request.user.books:
            start_date = None
            end_date = None
            try:
                start_date = timezone.datetime.fromisoformat(book.get('start_date')) if book.get('start_date') else None
                end_date = timezone.datetime.fromisoformat(book.get('end_date')) if book.get('end_date') else None
            except Exception:
                # If parsing fails, leave dates as None
                pass

            # Determine overdue status
            is_overdue = False
            if end_date:
                is_overdue = end_date < timezone.now()

            # Enrich with DB fields when possible
            author = ''
            category = ''
            image = book.get('image')
            if book.get('id'):
                db_book = Book.objects.filter(id=book.get('id')).first()
                if db_book:
                    author = getattr(db_book, 'author', '')
                    # Use subject as category for display consistency
                    category = getattr(db_book, 'subject', '')
                    # Prefer stored image url if not present
                    if not image and db_book.image:
                        image = db_book.image.url

            user_books.append({
                'title': book.get('title'),
                'id': book.get('id'),
                'image': image,
                'author': author,
                'category': category,
                'start_date': start_date,
                'end_date': end_date,
                'is_overdue': is_overdue,
            })

    # Pending fines and access restrictions
    pending_fines = Fine.objects.filter(user=request.user, status='PENDING')
    has_access_restrictions = pending_fines.exists()

    context = {
        'user': request.user,
        'user_books': user_books,
        'pending_fines': pending_fines,
        'has_access_restrictions': has_access_restrictions,
    }
    return render(request, 'libapp/user_dashboard.html', context)
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })

# --- Backend endpoint to update user details ---
@login_required
def update_user(request):
    """Update the logged-in user's details (backend only).
    Accepts POST with fields: username, email, phone, optional password.
    Returns JSON response; GET returns current details.
    """
    if request.method == 'GET':
        u = request.user
        return JsonResponse({
            'status': 'ok',
            'user': {
                'username': u.username,
                'email': u.email,
                'phone': u.phone,
            }
        })

    if request.method != 'POST':
        return HttpResponseNotAllowed(['POST', 'GET'])

    form = UserUpdateForm(request.POST, instance=request.user)
    if form.is_valid():
        data = form.cleaned_data
        username = data.get('username') or request.user.username
        email = data.get('email') or request.user.email
        phone = data.get('phone') or request.user.phone
        password = data.get('password')

        # Basic validations
        if username and len(username) < 5:
            return JsonResponse({'status': 'error', 'error': 'Username must be at least 5 characters long.'}, status=400)
        if password and len(password) < 8:
            return JsonResponse({'status': 'error', 'error': 'Password must be at least 8 characters long.'}, status=400)
        if phone and len(phone) < 10:
            return JsonResponse({'status': 'error', 'error': 'Phone number should have at least ten digits.'}, status=400)

        # Uniqueness checks for username/email
        from .models import CustomUser as CU
        if username and CU.objects.exclude(pk=request.user.pk).filter(username=username).exists():
            return JsonResponse({'status': 'error', 'error': 'Username already taken.'}, status=400)
        if email and CU.objects.exclude(pk=request.user.pk).filter(email=email).exists():
            return JsonResponse({'status': 'error', 'error': 'Email already in use.'}, status=400)

        user = request.user
        user.username = username
        user.email = email
        user.phone = phone
        if password:
            user.set_password(password)
        user.save()

        return JsonResponse({'status': 'ok', 'message': 'Profile updated successfully.', 'user': {
            'username': user.username,
            'email': user.email,
            'phone': user.phone,
        }})

    return JsonResponse({'status': 'error', 'errors': form.errors}, status=400)
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        user = authenticate(username=username, password=password)
        
        if user is not None and user.is_librarian:
            auth_login(request, user)
            messages.success(request, f'Welcome back, Librarian {user.username}!')
            return redirect('librarian_dashboard')
        else:
            messages.error(request, 'Invalid librarian credentials.')
            return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
    return redirect('login_librarian')

# Test SMS functionality
@login_required
def test_sms(request):
    """Test SMS functionality"""
    if request.method == 'POST':
        try:
            # Send test SMS to user's registered number
            success = sms_service.send_registration_sms(request.user)
            if success:
                messages.success(request, f'Test SMS sent to {request.user.phone}! Check the console/terminal for SMS details.')
            else:
                messages.error(request, 'Failed to send test SMS.')
        except Exception as e:
            messages.error(request, f'SMS test failed: {str(e)}')
    
    return render(request, 'libapp/test_sms.html', {
        'user': request.user
    })

# Mobile Notification Views
@login_required
def mobile_notification(request, notification_id):
    """Display mobile notification with BIMA ID"""
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found.')
        return redirect('user_dashboard')
    
    return render(request, 'libapp/mobile_notification.html', {
        'notification': notification
    })

@login_required
def respond_notification(request, notification_id):
    """Handle yes/no response to mobile notification"""
    if request.method != 'POST':
        return redirect('user_dashboard')
    
    try:
        notification = MobileNotification.objects.get(
            id=notification_id, 
            user=request.user,
            status='PENDING'
        )
    except MobileNotification.DoesNotExist:
        messages.error(request, 'Notification not found or already responded.')
        return redirect('user_dashboard')
    
    if notification.is_expired():
        notification.status = 'EXPIRED'
        notification.save()
        messages.warning(request, 'This notification has expired.')
        return redirect('user_dashboard')
    
    response = request.POST.get('response')
    if response not in ['yes', 'no']:
        messages.error(request, 'Invalid response.')
        return redirect('user_dashboard')
    
    # Update notification status
    notification.status = 'CONFIRMED' if response == 'yes' else 'REJECTED'
    notification.response_date = timezone.now()
    notification.save()
    
    # Handle the response based on notification type
    if response == 'yes':
        if notification.notification_type == 'BOOK_BORROWED':
            messages.success(request, f'Confirmed: You have successfully borrowed "{notification.book_title}".')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.success(request, f'Confirmed: You have successfully returned "{notification.book_title}".')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.info(request, f'Confirmed: Fine acknowledged for "{notification.book_title}".')
    else:
        if notification.notification_type == 'BOOK_BORROWED':
            messages.warning(request, f'Rejected: Book borrowing for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'BOOK_RETURNED':
            messages.warning(request, f'Rejected: Book return for "{notification.book_title}" was not confirmed.')
        elif notification.notification_type == 'FINE_IMPOSED':
            messages.warning(request, f'Rejected: Fine for "{notification.book_title}" was not acknowledged.')
    
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_borrow_notification(request, book_id):
    """Create mobile notification when user borrows a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('explore')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_BORROWED',
        title=f'Book Borrowed: {book.title}',
        message=f'You have successfully borrowed "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def create_book_return_notification(request, book_id):
    """Create mobile notification when user returns a book"""
    try:
        book = Book.objects.get(id=book_id)
    except Book.DoesNotExist:
        messages.error(request, 'Book not found.')
        return redirect('user_dashboard')
    
    # Create mobile notification
    notification = MobileNotification.objects.create(
        user=request.user,
        notification_type='BOOK_RETURNED',
        title=f'Book Returned: {book.title}',
        message=f'You have successfully returned "{book.title}" by {book.author}. Please confirm this transaction.',
        book_title=book.title,
        book_id=book.id
    )
    
    messages.success(request, f'Mobile notification sent! BIMA ID: {notification.bima_id}')
    return redirect('mobile_notification', notification_id=notification.id)

@login_required
def my_notifications(request):
    """Display user's mobile notifications"""
    notifications = MobileNotification.objects.filter(
        user=request.user
    ).order_by('-created_date')
    
    return render(request, 'libapp/my_notifications.html', {
        'notifications': notifications
    })
